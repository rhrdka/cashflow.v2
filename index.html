<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cashflow Pro v3.0 Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary: #4cc9f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --radius-lg: 16px;
            --radius-md: 12px;
            --sidebar-width: 280px;
        }

        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--light); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }

        /* === LAYOUT === */
        .app-wrapper { display: flex; min-height: 100vh; position: relative; }
        
        /* Sidebar & Overlay */
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 49;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: all; }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            position: fixed; top: 0; bottom: 0; left: 0;
            z-index: 50;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
            padding: 24px;
            overflow-y: auto;
        }

        /* Mobile Sidebar Logic */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
        }

        .logo-area { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
        .logo-icon { width: 36px; height: 36px; background: var(--primary); color: white; border-radius: 10px; display: grid; place-items: center; font-size: 20px; }
        .logo-text { font-size: 1.25rem; font-weight: 700; }

        /* Navigation */
        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: var(--radius-md); color: var(--text-sub);
            text-decoration: none; font-weight: 500; cursor: pointer; border: none; background: none; width: 100%;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(67, 97, 238, 0.08); color: var(--primary); }
        .nav-item.active { font-weight: 700; border-right: 3px solid var(--primary); }

        /* Profile Section inside Sidebar */
        .profile-card {
            background: var(--light); border: 1px solid var(--border);
            padding: 16px; border-radius: var(--radius-md); margin-top: auto;
        }
        .profile-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .avatar { width: 40px; height: 40px; background: var(--primary-dark); color: white; border-radius: 50%; display: grid; place-items: center; font-weight: 700; }
        .profile-stats { font-size: 0.85rem; display: flex; flex-direction: column; gap: 6px; }
        .stat-row { display: flex; justify-content: space-between; color: var(--text-sub); }
        .stat-row span:last-child { font-weight: 600; color: var(--text-main); }
        
        .daily-advice {
            margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); 
            border-radius: 8px; color: var(--success); font-size: 0.8rem; line-height: 1.4;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1; margin-left: var(--sidebar-width); padding: 32px 24px;
            transition: margin 0.3s; width: 100%;
        }
        @media (max-width: 768px) { .main-content { margin-left: 0; padding: 20px 16px; } }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; gap: 16px; }
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        @media (max-width: 768px) { .mobile-menu-btn { display: block; } }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--surface); padding: 20px; border-radius: var(--radius-lg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid var(--border);
        }
        .stat-label { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        
        /* Charts */
        .chart-container {
            background: var(--surface); padding: 20px; border-radius: var(--radius-lg);
            border: 1px solid var(--border); margin-bottom: 24px; height: 300px;
        }

        /* Transactions & Filters */
        .transactions-card { background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); overflow: hidden; }
        
        .filters-bar {
            padding: 16px; border-bottom: 1px solid var(--border);
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
        }
        
        /* FILTER BUTTON BORDERS ADDED HERE */
        .filter-btn {
            background: transparent; border: 1px solid var(--border); /* BORDER ADDED */
            padding: 8px 16px; border-radius: 20px; font-size: 0.9rem;
            color: var(--text-sub); cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        .filter-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
        }
        .filter-btn:hover:not(.active) { border-color: var(--primary); color: var(--primary); }

        .transaction-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; border-bottom: 1px solid var(--border); gap: 12px;
        }
        .t-left { display: flex; align-items: center; gap: 12px; }
        .t-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: grid; place-items: center; font-size: 1.2rem; flex-shrink: 0;
        }
        .t-info h4 { font-size: 0.95rem; margin-bottom: 2px; }
        .t-info span { font-size: 0.8rem; color: var(--text-sub); }
        .t-right { text-align: right; }
        .t-amount { font-weight: 700; font-size: 1rem; }
        .t-actions { display: flex; gap: 8px; margin-top: 4px; justify-content: flex-end; }
        
        .action-btn {
            font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);
            background: transparent; cursor: pointer; color: var(--text-sub);
        }
        .action-btn.edit:hover { color: var(--primary); border-color: var(--primary); }
        .action-btn.delete:hover { color: var(--danger); border-color: var(--danger); }

        /* Forms & Inputs */
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        .input-group input, .input-group select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--light); font-size: 1rem;
        }
        .btn {
            width: 100%; padding: 14px; border-radius: 10px; border: none;
            font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        
        /* Modal for Profile Edit */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content {
            background: white; width: 100%; max-width: 400px; padding: 24px;
            border-radius: 20px; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Auth */
        .auth-container {
            position: fixed; inset: 0; z-index: 200; background: white;
            display: grid; place-items: center; padding: 20px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="authContainer" class="auth-container">
        <div style="width: 100%; max-width: 400px; text-align: center;">
            <div style="width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 16px; display: grid; place-items: center; font-size: 32px; margin: 0 auto 24px;">
                <i class="ph ph-wallet"></i>
            </div>
            <h2 id="authTitle" style="margin-bottom: 8px;">Selamat Datang</h2>
            <p id="authSub" style="color: var(--text-sub); margin-bottom: 32px;">Kelola keuangan Anda lebih cerdas.</p>
            
            <form id="authForm">
                <div class="input-group" style="text-align: left;">
                    <label>Email</label>
                    <input type="email" id="authEmail" required placeholder="email@contoh.com">
                </div>
                <div id="registerFields" class="hidden">
                    <div class="input-group" style="text-align: left;">
                        <label>Nama Lengkap</label>
                        <input type="text" id="authName" placeholder="Nama Anda">
                    </div>
                </div>
                <div class="input-group" style="text-align: left;">
                    <label>Password</label>
                    <input type="password" id="authPass" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary" id="authBtn">Masuk</button>
            </form>
            
            <div style="margin-top: 24px; font-size: 0.9rem;">
                <span id="authSwitchText">Belum punya akun?</span>
                <a href="#" onclick="toggleAuthMode()" style="color: var(--primary); font-weight: 700; text-decoration: none;" id="authSwitchLink">Daftar sekarang</a>
            </div>
        </div>
    </div>

    <div id="appContainer" class="app-wrapper hidden">
        
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <aside class="sidebar" id="sidebar">
            <div class="logo-area">
                <div class="logo-icon"><i class="ph ph-wallet"></i></div>
                <div class="logo-text">Cashflow Pro</div>
            </div>

            <nav class="nav-menu">
                <button class="nav-item active" onclick="switchPage('dashboard', this)">
                    <i class="ph ph-squares-four"></i> Dashboard
                </button>
                <button class="nav-item" onclick="switchPage('input', this)">
                    <i class="ph ph-plus-circle"></i> Input Transaksi
                </button>
                <button class="nav-item" onclick="switchPage('history', this)">
                    <i class="ph ph-list-dashes"></i> Riwayat
                </button>
            </nav>

            <div class="profile-card">
                <div class="profile-header" onclick="openProfileModal()" style="cursor: pointer;">
                    <div class="avatar" id="sideAvatar">U</div>
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-weight: 700; font-size: 0.95rem;" id="sideName">User</div>
                        <div style="font-size: 0.75rem; color: var(--primary);">Klik untuk edit profil</div>
                    </div>
                    <i class="ph ph-gear"></i>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-row">
                        <span>Gaji:</span>
                        <span id="sideSalary">Rp 0</span>
                    </div>
                    <div class="stat-row">
                        <span>Target:</span>
                        <span id="sideTarget">Rp 0</span>
                    </div>
                </div>

                <div class="daily-advice" id="budgetAdvice">
                    <i class="ph ph-lightbulb"></i> Atur profil untuk melihat saran pengeluaran harian.
                </div>
                
                <button onclick="logout()" style="width: 100%; margin-top: 12px; padding: 8px; border: 1px solid var(--danger); background: transparent; color: var(--danger); border-radius: 8px; cursor: pointer;">
                    Keluar
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="ph ph-list"></i>
                    </button>
                    <div>
                        <h2 style="font-weight: 700; font-size: 1.5rem;" id="pageTitle">Overview</h2>
                        <p style="color: var(--text-sub); font-size: 0.9rem;" id="currentDate">...</p>
                    </div>
                </div>
            </div>

            <div id="dashboardPage" class="page-section">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Pemasukan Bulan Ini</div>
                        <div class="stat-value" id="dashIncome" style="color: var(--success)">Rp 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pengeluaran Bulan Ini</div>
                        <div class="stat-value" id="dashExpense" style="color: var(--danger)">Rp 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Saldo Bersih</div>
                        <div class="stat-value" id="dashBalance" style="color: var(--primary)">Rp 0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>

                <div class="transactions-card">
                    <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 1.1rem;">Transaksi Terbaru</h3>
                        <button onclick="switchPage('history')" style="background: none; border: none; color: var(--primary); cursor: pointer;">Lihat Semua</button>
                    </div>
                    <div id="recentList"></div>
                </div>
            </div>

            <div id="inputPage" class="page-section hidden">
                <div style="max-width: 500px; margin: 0 auto; background: var(--surface); padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 20px;" id="inputFormTitle">Tambah Transaksi</h3>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="filter-btn active" style="flex: 1; text-align: center;" onclick="setTxType('income')" id="btnIn">Pemasukan</button>
                        <button type="button" class="filter-btn" style="flex: 1; text-align: center;" onclick="setTxType('expense')" id="btnEx">Pengeluaran</button>
                    </div>

                    <form id="txForm">
                        <div class="input-group">
                            <label>Jumlah (Rp)</label>
                            <input type="text" id="inAmount" placeholder="0" required style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                        </div>
                        <div class="input-group">
                            <label>Kategori</label>
                            <select id="inCategory" required></select>
                        </div>
                        <div class="input-group">
                            <label>Tanggal</label>
                            <input type="date" id="inDate" required>
                        </div>
                        <div class="input-group">
                            <label>Catatan</label>
                            <input type="text" id="inNote" placeholder="Contoh: Makan siang">
                        </div>
                        <button type="submit" class="btn btn-primary" id="btnSaveTx">
                            <i class="ph ph-floppy-disk"></i> SIMPAN
                        </button>
                        <button type="button" class="btn" style="background: transparent; color: var(--text-sub); border: 1px solid var(--border); margin-top: 10px;" onclick="resetForm()">
                            Batal / Reset
                        </button>
                    </form>
                </div>
            </div>

            <div id="historyPage" class="page-section hidden">
                <div class="transactions-card">
                    <div class="filters-bar">
                        <button class="filter-btn active" onclick="filterHistory('all', this)">Semua</button>
                        <button class="filter-btn" onclick="filterHistory('income', this)">Pemasukan</button>
                        <button class="filter-btn" onclick="filterHistory('expense', this)">Pengeluaran</button>
                    </div>
                    <div id="fullHistoryList"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="profileModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-bottom: 16px;">Pengaturan Profil</h3>
            <form id="profileForm">
                <div class="input-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="profName" required>
                </div>
                <div class="input-group">
                    <label>Gaji Bulanan (Rp)</label>
                    <input type="text" id="profSalary" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Target Tabungan Bulanan (Rp)</label>
                    <input type="text" id="profTarget" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Tanggal Lahir</label>
                    <input type="date" id="profDob">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn" style="background: var(--light); color: var(--text-main);" onclick="closeProfileModal()">Tutup</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === STATE MANAGEMENT ===
        const state = {
            user: JSON.parse(localStorage.getItem('user')) || null,
            txs: JSON.parse(localStorage.getItem('txs')) || [],
            type: 'income',
            editingId: null,
            chart: null
        };

        const CATEGORIES = {
            income: ['Gaji', 'Bonus', 'Freelance', 'Investasi', 'Lainnya'],
            expense: ['Makanan', 'Transport', 'Belanja', 'Tagihan', 'Hiburan', 'Kesehatan', 'Lainnya']
        };

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            if (state.user) {
                initApp();
            } else {
                document.getElementById('authContainer').classList.remove('hidden');
            }
            
            // Format Number Inputs
            ['inAmount', 'profSalary', 'profTarget'].forEach(id => {
                document.getElementById(id).addEventListener('input', formatCurrencyInput);
            });

            // Date Header
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('id-ID', options);
        });

        // === AUTH ===
        let isLoginMode = true;
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').textContent = isLoginMode ? 'Selamat Datang' : 'Buat Akun';
            document.getElementById('authBtn').textContent = isLoginMode ? 'Masuk' : 'Daftar Akun';
            document.getElementById('registerFields').classList.toggle('hidden', isLoginMode);
            document.getElementById('authSwitchText').textContent = isLoginMode ? 'Belum punya akun?' : 'Sudah punya akun?';
            document.getElementById('authSwitchLink').textContent = isLoginMode ? 'Daftar sekarang' : 'Login';
        }

        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            
            // Simpel Mock Auth
            if (!isLoginMode) {
                const name = document.getElementById('authName').value;
                state.user = { email, name, salary: 0, target: 0, dob: '' };
                localStorage.setItem('user', JSON.stringify(state.user));
                initApp();
            } else {
                // Check if user exists (mock) or just login current stored
                if (state.user && state.user.email === email) {
                    initApp();
                } else if (!state.user) {
                    // Auto create simple user if nothing exists for demo
                    state.user = { email, name: 'Pengguna', salary: 0, target: 0, dob: '' };
                    localStorage.setItem('user', JSON.stringify(state.user));
                    initApp();
                } else {
                    alert('Login berhasil (Demo Mode)');
                    initApp();
                }
            }
        });

        function logout() {
            if(confirm('Keluar dari aplikasi?')) {
                // Optional: localStorage.clear(); if want to wipe data
                location.reload();
            }
        }

        function initApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            updateProfileUI();
            updateUI();
        }

        // === UI UPDATES ===
        function updateUI() {
            const sorted = [...state.txs].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            // Dashboard Logic
            const now = new Date();
            const thisMonth = now.toISOString().slice(0, 7);
            const monthTxs = sorted.filter(t => t.date.startsWith(thisMonth));
            
            const income = monthTxs.filter(t => t.type === 'income').reduce((a,b) => a + b.amount, 0);
            const expense = monthTxs.filter(t => t.type === 'expense').reduce((a,b) => a + b.amount, 0);
            
            document.getElementById('dashIncome').textContent = formatRupiah(income);
            document.getElementById('dashExpense').textContent = formatRupiah(expense);
            document.getElementById('dashBalance').textContent = formatRupiah(income - expense);

            renderTransactions(sorted.slice(0, 5), 'recentList');
            renderTransactions(sorted, 'fullHistoryList');
            renderChart(sorted);
        }

        // === TRANSACTIONS ===
        function setTxType(type) {
            state.type = type;
            document.getElementById('btnIn').className = `filter-btn ${type === 'income' ? 'active' : ''}`;
            document.getElementById('btnEx').className = `filter-btn ${type === 'expense' ? 'active' : ''}`;
            
            const sel = document.getElementById('inCategory');
            sel.innerHTML = '<option value="">Pilih Kategori</option>';
            CATEGORIES[type].forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        }
        
        // Init default
        setTxType('income');
        document.getElementById('inDate').valueAsDate = new Date();

        document.getElementById('txForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const rawAmt = document.getElementById('inAmount').value.replace(/\D/g, '');
            const amount = parseInt(rawAmt);
            
            const tx = {
                id: state.editingId || Date.now(),
                type: state.type,
                amount: amount,
                category: document.getElementById('inCategory').value,
                date: document.getElementById('inDate').value,
                note: document.getElementById('inNote').value
            };

            if (state.editingId) {
                // Edit mode: replace existing
                const index = state.txs.findIndex(t => t.id === state.editingId);
                if (index !== -1) state.txs[index] = tx;
                alert('Transaksi diperbarui!');
            } else {
                // Add mode
                state.txs.push(tx);
                alert('Transaksi disimpan!');
            }

            localStorage.setItem('txs', JSON.stringify(state.txs));
            resetForm();
            updateUI();
            switchPage('dashboard');
        });

        function resetForm() {
            document.getElementById('txForm').reset();
            state.editingId = null;
            document.getElementById('inputFormTitle').textContent = 'Tambah Transaksi';
            document.getElementById('btnSaveTx').innerHTML = '<i class="ph ph-floppy-disk"></i> SIMPAN';
            document.getElementById('inDate').valueAsDate = new Date();
            setTxType('income');
        }

        function renderTransactions(data, elId) {
            const container = document.getElementById(elId);
            if(data.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sub)">Belum ada data.</div>';
                return;
            }
            
            container.innerHTML = data.map(t => `
                <div class="transaction-row">
                    <div class="t-left">
                        <div class="t-icon" style="background: ${t.type==='income'?'rgba(16,185,129,0.1)':'rgba(239,68,68,0.1)'}; color:${t.type==='income'?'var(--success)':'var(--danger)'}">
                            <i class="ph ${getIcon(t.category)}"></i>
                        </div>
                        <div class="t-info">
                            <h4>${t.category}</h4>
                            <span>${new Date(t.date).toLocaleDateString('id-ID', {day:'numeric', month:'short'})} • ${t.note || '-'}</span>
                        </div>
                    </div>
                    <div class="t-right">
                        <div class="t-amount" style="color:${t.type==='income'?'var(--success)':'var(--danger)'}">
                            ${t.type==='income'?'+':'-'} ${formatRupiah(t.amount, false)}
                        </div>
                        <div class="t-actions">
                            <button class="action-btn edit" onclick="editTx(${t.id})">Edit</button>
                            <button class="action-btn delete" onclick="deleteTx(${t.id})">Hapus</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteTx(id) {
            if(confirm('Hapus transaksi ini?')) {
                state.txs = state.txs.filter(t => t.id !== id);
                localStorage.setItem('txs', JSON.stringify(state.txs));
                updateUI();
            }
        }

        function editTx(id) {
            const tx = state.txs.find(t => t.id === id);
            if (!tx) return;

            switchPage('input');
            state.editingId = id;
            document.getElementById('inputFormTitle').textContent = 'Edit Transaksi';
            document.getElementById('btnSaveTx').innerHTML = '<i class="ph ph-check"></i> UPDATE';

            setTxType(tx.type);
            document.getElementById('inCategory').value = tx.category;
            document.getElementById('inAmount').value = formatRupiah(tx.amount, false);
            document.getElementById('inDate').value = tx.date;
            document.getElementById('inNote').value = tx.note;
        }

        function filterHistory(type, btn) {
            document.querySelectorAll('#historyPage .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            let data = [...state.txs].sort((a,b) => new Date(b.date) - new Date(a.date));
            if(type !== 'all') {
                data = data.filter(t => t.type === type);
            }
            renderTransactions(data, 'fullHistoryList');
        }

        // === PROFILE & BUDGET LOGIC ===
        function updateProfileUI() {
            document.getElementById('sideName').textContent = state.user.name;
            document.getElementById('sideAvatar').textContent = state.user.name.charAt(0).toUpperCase();
            document.getElementById('sideSalary').textContent = formatRupiah(state.user.salary);
            document.getElementById('sideTarget').textContent = formatRupiah(state.user.target);

            // Calculate Daily Advice
            if (state.user.salary > 0) {
                const daysInMonth = 30;
                const disposableIncome = state.user.salary - state.user.target;
                const dailyLimit = disposableIncome / daysInMonth;
                
                if (dailyLimit > 0) {
                    document.getElementById('budgetAdvice').innerHTML = `
                        <i class="ph ph-trend-up"></i> <b>Saran:</b><br>
                        Batasi pengeluaran <b>${formatRupiah(dailyLimit)}</b> / hari untuk mencapai target.
                    `;
                } else {
                    document.getElementById('budgetAdvice').innerHTML = `<span style="color:var(--danger)">Target tabungan terlalu tinggi dibanding gaji!</span>`;
                }
            }
        }

        function openProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profName').value = state.user.name;
            document.getElementById('profSalary').value = formatRupiah(state.user.salary || 0, false);
            document.getElementById('profTarget').value = formatRupiah(state.user.target || 0, false);
            document.getElementById('profDob').value = state.user.dob || '';
            
            // Close sidebar if open
            if(window.innerWidth <= 768) toggleSidebar();
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        document.getElementById('profileForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const salary = parseInt(document.getElementById('profSalary').value.replace(/\D/g, '')) || 0;
            const target = parseInt(document.getElementById('profTarget').value.replace(/\D/g, '')) || 0;
            
            state.user.name = document.getElementById('profName').value;
            state.user.salary = salary;
            state.user.target = target;
            state.user.dob = document.getElementById('profDob').value;
            
            localStorage.setItem('user', JSON.stringify(state.user));
            updateProfileUI();
            closeProfileModal();
        });

        // === CHART ===
        function renderChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // Group by month (last 6 months)
            const months = {};
            const labels = [];
            for(let i=5; i>=0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const key = d.toISOString().slice(0, 7);
                months[key] = { inc: 0, exp: 0 };
                labels.push(d.toLocaleDateString('id-ID', {month:'short'}));
            }

            data.forEach(t => {
                const key = t.date.slice(0, 7);
                if(months[key]) {
                    if(t.type === 'income') months[key].inc += t.amount;
                    else months[key].exp += t.amount;
                }
            });

            const dsIncome = Object.values(months).map(v => v.inc);
            const dsExpense = Object.values(months).map(v => v.exp);

            if(state.chart) state.chart.destroy();

            // Gradient
            const gradientInc = ctx.createLinearGradient(0,0,0,300);
            gradientInc.addColorStop(0, 'rgba(67, 97, 238, 0.4)');
            gradientInc.addColorStop(1, 'rgba(67, 97, 238, 0.0)');

            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Masuk', data: dsIncome, borderColor: '#4361ee', backgroundColor: gradientInc, fill: true, tension: 0.4 },
                        { label: 'Keluar', data: dsExpense, borderColor: '#ef4444', borderDash: [5,5], tension: 0.4, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } },
                        tooltip: { mode: 'index', intersect: false, backgroundColor: '#1e293b' }
                    },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // === HELPERS ===
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sb.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function switchPage(pageId, btn) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId + 'Page').classList.remove('hidden');
            
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            
            // Close sidebar on mobile
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        }

        function formatRupiah(num, prefix='Rp ') {
            if(!num) num = 0;
            return (prefix ? 'Rp ' : '') + num.toLocaleString('id-ID');
        }

        function formatCurrencyInput(e) {
            let val = e.target.value.replace(/\D/g, '');
            if(val) e.target.value = parseInt(val).toLocaleString('id-ID');
        }

        function getIcon(cat) {
            const map = {
                'Gaji': 'ph-briefcase', 'Makanan': 'ph-hamburger', 'Transport': 'ph-car',
                'Belanja': 'ph-shopping-bag', 'Hiburan': 'ph-popcorn', 'Investasi': 'ph-chart-line-up',
                'Kesehatan': 'ph-heart-beat', 'Tagihan': 'ph-receipt'
            };
            return map[cat] || 'ph-money';
        }

        // Touch Swipe to Close Sidebar
        let touchStartX = 0;
        document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
        document.addEventListener('touchend', e => {
            if (touchStartX < 250 && e.changedTouches[0].screenX < touchStartX - 50) {
                 // Swipe Left to close
                 document.getElementById('sidebar').classList.remove('active');
                 document.getElementById('sidebarOverlay').classList.remove('active');
            }
        });
    </script>
</body>
</html>
