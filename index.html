<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cashflow Manager Pro v2.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* === THEME VARIABLES === */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary: #4cc9f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --bg-hover: #f1f5f9;
            --bg-input: #ffffff;
            
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #cbd5e1;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --bg-hover: #334155;
            --bg-input: #1e293b;
            
            --text-main: #f8fafc;
            --text-sub: #cbd5e1;
            --border: #475569;
            --shadow-card: none;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* === LAYOUT & OVERLAY === */
        .sidebar-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            position: fixed; top: 0; bottom: 0; left: 0;
            z-index: 50;
            padding: 24px;
            display: flex; flex-direction: column;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            transition: margin-left 0.3s;
        }

        /* === COMPONENTS === */
        /* Profile Section in Sidebar */
        .profile-section {
            background: var(--bg-hover);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        .profile-input-group { margin-bottom: 12px; }
        .profile-input-group label { font-size: 0.75rem; color: var(--text-sub); display: block; margin-bottom: 4px; }
        .profile-input-group input { 
            width: 100%; padding: 8px; font-size: 0.9rem; 
            border: 1px solid var(--border); border-radius: 6px;
            background: var(--bg-surface); color: var(--text-main);
        }

        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-sub);
            font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: none; background: none; width: 100%; text-align: left;
            margin-bottom: 4px;
        }
        .nav-item.active { background: rgba(67, 97, 238, 0.1); color: var(--primary); font-weight: 600; }

        /* Dashboard Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-surface);
            padding: 20px; border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-card);
        }
        .stat-label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 6px; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--text-main); }
        .daily-advice { font-size: 0.8rem; margin-top: 8px; color: var(--primary); font-weight: 600; }

        /* Transaction List */
        .filter-group { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border); /* Request: Border added */
            background: var(--bg-surface);
            color: var(--text-sub);
            border-radius: 8px;
            cursor: pointer; font-weight: 500;
            transition: all 0.2s;
        }
        .filter-btn.active { border-color: var(--primary); background: rgba(67, 97, 238, 0.1); color: var(--primary); }

        .transaction-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; border-bottom: 1px solid var(--border);
            background: var(--bg-surface);
        }
        .tx-left { display: flex; align-items: center; gap: 12px; }
        .tx-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: grid; place-items: center; font-size: 1.2rem;
        }
        .tx-details h4 { font-size: 0.95rem; color: var(--text-main); }
        .tx-details p { font-size: 0.8rem; color: var(--text-sub); }
        .tx-right { text-align: right; }
        .tx-amount { font-weight: 700; display: block; }
        .tx-actions { margin-top: 4px; display: flex; gap: 12px; justify-content: flex-end; }
        .action-icon { cursor: pointer; font-size: 1.1rem; padding: 4px; transition: transform 0.2s; }
        .action-icon:hover { transform: scale(1.1); }

        /* Mobile Responsive */
        .mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        
        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .mobile-header { display: flex; }
            .dashboard-grid { grid-template-columns: 1fr; }
            
            /* Hide desktop header details on mobile */
            .desktop-header { display: none; }
        }

        /* Utils */
        .hidden { display: none !important; }
        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 12px; border-radius: 10px; width: 100%; font-weight: 600; cursor: pointer;
        }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            background: var(--bg-input); color: var(--text-main);
            border-radius: 10px; font-family: inherit; margin-bottom: 16px;
        }
    </style>
</head>
<body>

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div id="authContainer" style="position:fixed; inset:0; z-index:100; background:var(--bg-body); display:grid; place-items:center;">
        <div style="background:var(--bg-surface); padding:32px; border-radius:24px; border:1px solid var(--border); width:90%; max-width:400px; text-align:center;">
            <h2 style="margin-bottom:8px; color:var(--text-main);">Cashflow Pro v2.2</h2>
            <p style="margin-bottom:24px; color:var(--text-sub);">Silakan login untuk melanjutkan</p>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="btn-primary" id="loginBtn">Masuk</button>
            </form>
            <p style="margin-top:16px; font-size:0.9rem; color:var(--text-sub);">Gunakan email yang terdaftar di Google Script Anda.</p>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        
        <aside class="sidebar" id="sidebar">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:24px; padding-left:8px;">
                <i class="ph ph-wallet" style="font-size:24px; color:var(--primary);"></i>
                <h2 style="font-size:1.2rem; font-weight:700;">Cashflow Pro</h2>
            </div>

            <div class="profile-section">
                <h4 style="margin-bottom:12px; font-size:0.9rem;">Profil Keuangan</h4>
                <div class="profile-input-group">
                    <label>Nama Pengguna</label>
                    <input type="text" id="profName" placeholder="Nama Anda">
                </div>
                <div class="profile-input-group">
                    <label>Gaji Bulanan (Rp)</label>
                    <input type="text" id="profSalary" placeholder="0" oninput="formatInput(this); updateAdvice()">
                </div>
                <div class="profile-input-group">
                    <label>Target Tabungan (Rp)</label>
                    <input type="text" id="profTarget" placeholder="0" oninput="formatInput(this); updateAdvice()">
                </div>
            </div>

            <nav style="flex:1;">
                <button class="nav-item active" onclick="switchPage('dashboard', this)"><i class="ph ph-squares-four"></i> Dashboard</button>
                <button class="nav-item" onclick="switchPage('input', this)"><i class="ph ph-plus-circle"></i> Input & Edit</button>
                <button class="nav-item" onclick="switchPage('history', this)"><i class="ph ph-list-dashes"></i> Riwayat</button>
            </nav>

            <button onclick="logout()" style="margin-top:auto; padding:12px; border:1px solid var(--danger); background:transparent; color:var(--danger); border-radius:10px; cursor:pointer; font-weight:600;">Keluar</button>
        </aside>

        <main class="main-content">
            <div class="mobile-header">
                <button onclick="openSidebar()" style="background:none; border:none; font-size:1.5rem; color:var(--text-main);"><i class="ph ph-list"></i></button>
                <h3 id="mobileTitle">Dashboard</h3>
                <button onclick="toggleTheme()" style="background:none; border:none; font-size:1.5rem; color:var(--text-main);"><i class="ph ph-moon"></i></button>
            </div>

            <div class="desktop-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <div>
                    <h1 style="font-size:1.5rem;">Ringkasan Keuangan</h1>
                    <p id="dateDisplay" style="color:var(--text-sub); font-size:0.9rem;"></p>
                </div>
                <button onclick="toggleTheme()" style="background:var(--bg-surface); border:1px solid var(--border); width:40px; height:40px; border-radius:50%; cursor:pointer; color:var(--text-main); display:grid; place-items:center;"><i class="ph ph-moon"></i></button>
            </div>

            <div id="dashboardPage" class="page-section">
                <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding:20px; border-radius:16px; color:white; margin-bottom:24px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <p style="font-size:0.9rem; opacity:0.9;">Saran Pengeluaran Harian</p>
                            <h2 id="dailyAdviceValue" style="font-size:1.8rem; font-weight:700;">Rp 0</h2>
                        </div>
                        <i class="ph ph-lightbulb" style="font-size:2rem; opacity:0.8;"></i>
                    </div>
                    <p style="font-size:0.8rem; margin-top:8px; opacity:0.8;">*Berdasarkan Gaji dikurang Target Tabungan dibagi 30 hari.</p>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Pemasukan</div>
                        <div class="stat-value" id="valIncome" style="color:var(--success);">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pengeluaran</div>
                        <div class="stat-value" id="valExpense" style="color:var(--danger);">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Saldo</div>
                        <div class="stat-value" id="valBalance" style="color:var(--primary);">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Progres Tabungan</div>
                        <div class="stat-value" id="valSavingsRatio" style="color:var(--warning);">0%</div>
                    </div>
                </div>

                <div style="background:var(--bg-surface); padding:20px; border-radius:16px; border:1px solid var(--border);">
                    <h3 style="margin-bottom:16px;">Grafik Arus Kas</h3>
                    <canvas id="mainChart" height="250"></canvas>
                </div>
            </div>

            <div id="inputPage" class="page-section hidden">
                <div style="max-width:600px; margin:0 auto; background:var(--bg-surface); padding:24px; border-radius:16px; border:1px solid var(--border);">
                    <h3 style="margin-bottom:20px;" id="formTitle">Tambah Transaksi Baru</h3>
                    
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button type="button" id="btnTypeIncome" onclick="setType('income')" style="flex:1; padding:12px; border:1px solid var(--border); border-radius:8px; cursor:pointer; background:var(--bg-body); font-weight:600;">Pemasukan</button>
                        <button type="button" id="btnTypeExpense" onclick="setType('expense')" style="flex:1; padding:12px; border:1px solid var(--border); border-radius:8px; cursor:pointer; background:var(--bg-body); font-weight:600;">Pengeluaran</button>
                    </div>

                    <form id="txForm">
                        <input type="hidden" id="editId"> <label style="font-size:0.9rem; color:var(--text-sub);">Jumlah (Rp)</label>
                        <input type="text" id="amount" placeholder="0" required oninput="formatInput(this)" style="font-size:1.5rem; font-weight:700;">
                        
                        <label style="font-size:0.9rem; color:var(--text-sub);">Kategori</label>
                        <select id="category" required></select>
                        
                        <label style="font-size:0.9rem; color:var(--text-sub);">Tanggal</label>
                        <input type="date" id="date" required>
                        
                        <label style="font-size:0.9rem; color:var(--text-sub);">Catatan</label>
                        <textarea id="notes" placeholder="Keterangan..." rows="3"></textarea>
                        
                        <div style="display:flex; gap:10px;">
                            <button type="button" onclick="resetForm()" id="btnCancel" class="hidden" style="padding:12px; border-radius:10px; border:1px solid var(--border); background:var(--bg-hover); cursor:pointer;">Batal</button>
                            <button type="submit" class="btn-primary" id="btnSubmit">Simpan Transaksi</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="historyPage" class="page-section hidden">
                <div style="background:var(--bg-surface); padding:20px; border-radius:16px; border:1px solid var(--border);">
                    <div class="filter-group">
                        <button class="filter-btn active" onclick="filterList('all', this)">Semua</button>
                        <button class="filter-btn" onclick="filterList('income', this)">Pemasukan</button>
                        <button class="filter-btn" onclick="filterList('expense', this)">Pengeluaran</button>
                    </div>
                    <input type="text" id="search" placeholder="Cari transaksi..." style="margin-bottom:20px;">
                    
                    <div id="txList">
                        </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // === CONFIG ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbx4kBUmk0MkbPq1C_4Vi1I6BSmVLLAD3IenNBNmRfGMs5Ae3l4QerEZypRnXwuJEnNolQ/exec';

        // === STATE ===
        let state = {
            user: JSON.parse(localStorage.getItem('user')) || null,
            transactions: [],
            currentType: 'income',
            profile: JSON.parse(localStorage.getItem('profile')) || { name: '', salary: 0, target: 0 }
        };

        // === INIT ===
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            if(state.user) {
                initApp();
            } else {
                document.getElementById('authContainer').style.display = 'grid';
            }
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('id-ID', { dateStyle: 'full' });
        });

        function initApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Load Profile to Inputs
            document.getElementById('profName').value = state.profile.name || '';
            document.getElementById('profSalary').value = formatRupiah(state.profile.salary);
            document.getElementById('profTarget').value = formatRupiah(state.profile.target);
            
            // Profile Listener
            ['profName', 'profSalary', 'profTarget'].forEach(id => {
                document.getElementById(id).addEventListener('input', saveProfile);
            });

            loadTransactions();
            setType('income');
            updateAdvice();
            document.getElementById('date').valueAsDate = new Date();
        }

        // === UI INTERACTION ===
        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.add('active');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        function switchPage(page, btn) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
            
            // Update Title Mobile
            const titles = { dashboard: 'Dashboard', input: 'Input Data', history: 'Riwayat' };
            document.getElementById('mobileTitle').textContent = titles[page];
            
            closeSidebar(); // Auto close on mobile
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            renderChart(); // Redraw chart for color update
        }

        function initTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', saved);
        }

        // === LOGIC ===
        async function loadTransactions() {
            try {
                // Fetch only if needed, for now simplified
                const res = await fetch(`${API_URL}?action=getTransactions&email=${state.user.email}`);
                const data = await res.json();
                if(data.status === 'success') {
                    state.transactions = data.data.sort((a,b) => new Date(b.date) - new Date(a.date));
                    updateDashboard();
                    renderList(state.transactions);
                }
            } catch(e) { console.error(e); }
        }

        function saveProfile() {
            const salary = parseInt(document.getElementById('profSalary').value.replace(/\D/g,'')) || 0;
            const target = parseInt(document.getElementById('profTarget').value.replace(/\D/g,'')) || 0;
            const name = document.getElementById('profName').value;
            
            state.profile = { name, salary, target };
            localStorage.setItem('profile', JSON.stringify(state.profile));
            updateAdvice();
        }

        function updateAdvice() {
            const salary = state.profile.salary;
            const target = state.profile.target;
            const disposable = Math.max(0, salary - target);
            const daily = Math.floor(disposable / 30);
            
            document.getElementById('dailyAdviceValue').textContent = 'Rp ' + daily.toLocaleString('id-ID');
        }

        function updateDashboard() {
            const inc = state.transactions.filter(t=>t.type=='income').reduce((a,b)=>a+b.amount,0);
            const exp = state.transactions.filter(t=>t.type=='expense').reduce((a,b)=>a+b.amount,0);
            
            document.getElementById('valIncome').textContent = formatRupiah(inc);
            document.getElementById('valExpense').textContent = formatRupiah(exp);
            document.getElementById('valBalance').textContent = formatRupiah(inc - exp);
            
            // Calc ratio to target
            const saved = inc - exp;
            const target = state.profile.target || 1;
            const ratio = Math.min(100, Math.max(0, (saved/target)*100)).toFixed(1);
            document.getElementById('valSavingsRatio').textContent = state.profile.target > 0 ? ratio + '%' : '-';

            renderChart();
        }

        function renderList(data) {
            const list = document.getElementById('txList');
            if(!data.length) { list.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sub);">Belum ada data.</p>'; return; }
            
            list.innerHTML = data.map(t => `
                <div class="transaction-item">
                    <div class="tx-left">
                        <div class="tx-icon" style="background:${t.type=='income'?'rgba(16,185,129,0.1)':'rgba(239,68,68,0.1)'}; color:${t.type=='income'?'var(--success)':'var(--danger)'}">
                            <i class="ph ${t.type=='income'?'ph-arrow-up':'ph-arrow-down'}"></i>
                        </div>
                        <div class="tx-details">
                            <h4>${t.description}</h4>
                            <p>${t.category} â€¢ ${t.date}</p>
                        </div>
                    </div>
                    <div class="tx-right">
                        <span class="tx-amount" style="color:${t.type=='income'?'var(--success)':'var(--danger)'}">
                            ${t.type=='income'?'+':'-'} ${formatRupiah(t.amount, false)}
                        </span>
                        <div class="tx-actions">
                            <i class="ph ph-pencil-simple action-icon" onclick="editTx(${t.id})" style="color:var(--primary)" title="Edit"></i>
                            <i class="ph ph-trash action-icon" onclick="deleteTx(${t.id})" style="color:var(--danger)" title="Hapus"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // === INPUT & EDIT LOGIC ===
        function setType(type) {
            state.currentType = type;
            const btnInc = document.getElementById('btnTypeIncome');
            const btnExp = document.getElementById('btnTypeExpense');
            
            // Reset styles
            [btnInc, btnExp].forEach(b => { b.style.borderColor = 'var(--border)'; b.style.color = 'var(--text-sub)'; });
            
            // Set active
            const activeBtn = type === 'income' ? btnInc : btnExp;
            const color = type === 'income' ? 'var(--success)' : 'var(--danger)';
            activeBtn.style.borderColor = color;
            activeBtn.style.color = color;
            
            // Populate Cats
            const cats = type === 'income' 
                ? ['Gaji', 'Bonus', 'Investasi', 'Lainnya'] 
                : ['Makan', 'Minum', 'Transport', 'Belanja', 'Tagihan', 'Hiburan', 'Lainnya'];
            
            document.getElementById('category').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function formatInput(el) {
            let val = el.value.replace(/\D/g, '');
            if(val) el.value = parseInt(val).toLocaleString('id-ID');
        }

        function formatRupiah(num, prefix=true) {
            return (prefix?'Rp ':'') + parseInt(num).toLocaleString('id-ID');
        }

        // Handle Edit
        function editTx(id) {
            const tx = state.transactions.find(t => t.id === id);
            if(!tx) return;
            
            // 1. Fill Form
            document.getElementById('editId').value = tx.id;
            document.getElementById('amount').value = formatRupiah(tx.amount, false);
            setType(tx.type);
            document.getElementById('category').value = tx.category;
            document.getElementById('date').value = tx.date;
            document.getElementById('notes').value = tx.notes || tx.description;
            
            // 2. Change UI State
            document.getElementById('formTitle').textContent = "Edit Transaksi";
            document.getElementById('btnSubmit').textContent = "Update Transaksi";
            document.getElementById('btnCancel').classList.remove('hidden');
            
            // 3. Navigate
            switchPage('input', document.querySelectorAll('.nav-item')[1]);
        }

        function resetForm() {
            document.getElementById('txForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = "Tambah Transaksi Baru";
            document.getElementById('btnSubmit').textContent = "Simpan Transaksi";
            document.getElementById('btnCancel').classList.add('hidden');
            document.getElementById('date').valueAsDate = new Date();
        }

        // Form Submit (Add or Update)
        document.getElementById('txForm').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const originalText = btn.textContent;
            btn.textContent = "Memproses..."; btn.disabled = true;

            const editId = document.getElementById('editId').value;
            const rawAmount = document.getElementById('amount').value.replace(/\./g, '');
            
            // Prepare Data
            const payload = {
                email: state.user.email,
                id: editId ? parseInt(editId) : Date.now(), // Use old ID if edit, new if add
                type: state.currentType,
                amount: parseInt(rawAmount),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                description: document.getElementById('notes').value || document.getElementById('category').value,
                notes: document.getElementById('notes').value
            };

            try {
                // If Editing: We must DELETE the old one first, then ADD the new one
                // (Since simple GAS scripts usually append row)
                if (editId) {
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'deleteTransaction', id: parseInt(editId), email: state.user.email })
                    });
                    // Remove local old
                    state.transactions = state.transactions.filter(t => t.id != editId);
                }

                // Add New (or Re-add updated)
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'addTransaction', ...payload })
                });

                state.transactions.unshift(payload);
                updateDashboard();
                renderList(state.transactions);
                
                alert(editId ? 'Transaksi berhasil diupdate!' : 'Transaksi berhasil disimpan!');
                resetForm();
                switchPage('history', document.querySelectorAll('.nav-item')[2]);

            } catch(err) {
                alert('Terjadi kesalahan koneksi.');
                console.error(err);
            } finally {
                btn.textContent = originalText; btn.disabled = false;
            }
        });

        // Delete Logic
        async function deleteTx(id) {
            if(!confirm('Yakin hapus data ini?')) return;
            // Optimistic UI
            const oldData = [...state.transactions];
            state.transactions = state.transactions.filter(t => t.id !== id);
            renderList(state.transactions);
            updateDashboard();

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteTransaction', id, email: state.user.email })
                });
            } catch(e) {
                alert('Gagal menghapus');
                state.transactions = oldData;
                renderList(state.transactions);
            }
        }

        // Auth Logic
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.textContent = 'Loading...'; btn.disabled = true;
            
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', email, password: pass })
                });
                const data = await res.json();
                if(data.status === 'success') {
                    state.user = data.data;
                    localStorage.setItem('user', JSON.stringify(state.user));
                    initApp();
                } else {
                    alert(data.message);
                }
            } catch(e) { alert('Error koneksi'); }
            finally { btn.textContent = 'Masuk'; btn.disabled = false; }
        });

        function logout() { localStorage.removeItem('user'); location.reload(); }

        // Filter Logic
        function filterList(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if(type === 'all') renderList(state.transactions);
            else renderList(state.transactions.filter(t => t.type === type));
        }

        document.getElementById('search').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            renderList(state.transactions.filter(t => 
                t.description.toLowerCase().includes(term) || t.category.toLowerCase().includes(term)
            ));
        });

        // Chart Logic
        let chartInstance = null;
        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            
            const months = {};
            state.transactions.forEach(t => {
                const m = t.date.slice(0, 7);
                if(!months[m]) months[m] = { inc: 0, exp: 0 };
                if(t.type === 'income') months[m].inc += t.amount;
                else months[m].exp += t.amount;
            });
            
            const labels = Object.keys(months).sort();
            const dInc = labels.map(k => months[k].inc);
            const dExp = labels.map(k => months[k].exp);

            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Masuk', data: dInc, borderColor: '#10b981', tension: 0.4 },
                        { label: 'Keluar', data: dExp, borderColor: '#ef4444', tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: isDark ? '#cbd5e1' : '#64748b' } } },
                    scales: {
                        y: { grid: { color: isDark ? '#334155' : '#e2e8f0' }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } },
                        x: { grid: { display: false }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
