<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cashflow Manager Pro v2.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee; --primary-dark: #3a0ca3; --secondary: #4cc9f0;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --bg-body: #f8fafc; --bg-surface: #ffffff; --bg-hover: #f1f5f9;
            --text-main: #0f172a; --text-sub: #64748b; --border: #cbd5e1;
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-surface: #1e293b; --bg-hover: #334155;
            --text-main: #f8fafc; --text-sub: #cbd5e1; --border: #475569;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); transition: 0.3s; }

        /* --- UI Components --- */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        .sidebar { 
            width: var(--sidebar-width); background: var(--bg-surface); border-right: 1px solid var(--border);
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; padding: 24px;
            display: flex; flex-direction: column; transform: translateX(0); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content { margin-left: var(--sidebar-width); padding: 24px; transition: 0.3s; }

        .network-status {
            position: fixed; top: 0; left: 0; right: 0; background: var(--danger); color: white;
            text-align: center; padding: 8px; font-size: 0.8rem; z-index: 9999;
            transform: translateY(-100%); transition: 0.3s;
        }
        .network-status.offline { transform: translateY(0); }

        .profile-section { background: var(--bg-hover); padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border); }
        .profile-input { width: 100%; padding: 8px; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-surface); color: var(--text-main); margin-bottom: 8px; }

        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-sub); font-weight: 500; cursor: pointer; border: none; background: none; width: 100%; text-align: left; margin-bottom: 4px; }
        .nav-item.active { background: rgba(67, 97, 238, 0.1); color: var(--primary); font-weight: 600; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); }

        .transaction-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border); background: var(--bg-surface); }
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-surface); border-radius: 8px; cursor: pointer; }
        .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(67, 97, 238, 0.1); }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .mobile-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg-surface); color: var(--text-main); margin-bottom: 12px; }
    </style>
</head>
<body>

    <div id="networkStatus" class="network-status">Mode Offline: Koneksi Terputus</div>
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div id="authContainer" style="position:fixed; inset:0; z-index:100; background:var(--bg-body); display:grid; place-items:center;">
        <div style="background:var(--bg-surface); padding:32px; border-radius:24px; border:1px solid var(--border); width:90%; max-width:400px; text-align:center;">
            <h2 style="margin-bottom:24px;">Cashflow Pro v2.5</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit" style="background:var(--primary); color:white; border:none; padding:12px; border-radius:10px; width:100%; font-weight:600; cursor:pointer;" id="loginBtn">Masuk</button>
            </form>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <aside class="sidebar" id="sidebar">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:24px;">
                <i class="ph ph-wallet" style="font-size:24px; color:var(--primary);"></i>
                <h2 style="font-size:1.2rem;">Manager Pro</h2>
            </div>

            <div class="profile-section">
                <p style="font-size:0.7rem; color:var(--text-sub); margin-bottom:8px;">FINANCIAL PLANNER</p>
                <input type="text" id="profSalary" class="profile-input" placeholder="Gaji Bulanan" oninput="formatInput(this); saveProfile()">
                <input type="text" id="profTarget" class="profile-input" placeholder="Target Tabungan" oninput="formatInput(this); saveProfile()">
            </div>

            <nav style="flex:1;">
                <button class="nav-item active" onclick="switchPage('dashboard', this)"><i class="ph ph-squares-four"></i> Dashboard</button>
                <button class="nav-item" onclick="switchPage('input', this)"><i class="ph ph-plus-circle"></i> Input Data</button>
                <button class="nav-item" onclick="switchPage('history', this)"><i class="ph ph-list-dashes"></i> Riwayat</button>
            </nav>

            <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:12px;" id="userInfoDisplay"></div>
            <button onclick="logout()" style="color:var(--danger); background:none; border:1px solid var(--danger); padding:8px; border-radius:8px; cursor:pointer;">Logout</button>
        </aside>

        <main class="main-content">
            <header class="mobile-header" style="display:none;">
                <button onclick="openSidebar()" style="background:none; border:none; font-size:1.5rem;"><i class="ph ph-list"></i></button>
                <h3 id="mobileTitle">Dashboard</h3>
                <button onclick="toggleTheme()" style="background:none; border:none; font-size:1.2rem;"><i class="ph ph-moon"></i></button>
            </header>

            <div id="dashboardPage" class="page-section">
                <div style="background:linear-gradient(135deg, var(--primary), var(--primary-dark)); padding:24px; border-radius:16px; color:white; margin-bottom:24px;">
                    <p style="opacity:0.8; font-size:0.9rem;">Saran Pengeluaran Maks/Hari</p>
                    <h2 id="dailyLimit" style="font-size:2rem;">Rp 0</h2>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card"><p class="text-sub">Pemasukan</p><h3 id="dashInc" style="color:var(--success);">0</h3></div>
                    <div class="stat-card"><p class="text-sub">Pengeluaran</p><h3 id="dashExp" style="color:var(--danger);">0</h3></div>
                    <div class="stat-card"><p class="text-sub">Saldo</p><h3 id="dashBal" style="color:var(--primary);">0</h3></div>
                </div>
                <div class="stat-card"><canvas id="mainChart"></canvas></div>
            </div>

            <div id="inputPage" class="page-section hidden">
                <div style="max-width:500px; margin:auto; background:var(--bg-surface); padding:24px; border-radius:16px; border:1px solid var(--border);">
                    <h3 id="formTitle">Tambah Transaksi</h3>
                    <div style="display:flex; gap:10px; margin:20px 0;">
                        <button id="typeInc" onclick="setType('income')" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); cursor:pointer;">Income</button>
                        <button id="typeExp" onclick="setType('expense')" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); cursor:pointer;">Expense</button>
                    </div>
                    <form id="txForm">
                        <input type="hidden" id="editId">
                        <input type="text" id="amount" placeholder="Jumlah (Rp)" required oninput="formatInput(this)">
                        <select id="category" required></select>
                        <input type="date" id="date" required>
                        <textarea id="notes" placeholder="Catatan"></textarea>
                        <div style="display:flex; gap:10px;">
                            <button type="button" id="btnCancel" class="hidden" onclick="resetForm()" style="flex:1; padding:12px; border-radius:10px; border:1px solid var(--border);">Batal</button>
                            <button type="submit" id="btnSubmit" style="flex:2; background:var(--primary); color:white; border:none; padding:12px; border-radius:10px; font-weight:600;">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="historyPage" class="page-section hidden">
                <div class="stat-card">
                    <div style="display:flex; gap:8px; margin-bottom:16px;">
                        <button class="filter-btn active" onclick="filterList('all', this)">Semua</button>
                        <button class="filter-btn" onclick="filterList('income', this)">Masuk</button>
                        <button class="filter-btn" onclick="filterList('expense', this)">Keluar</button>
                    </div>
                    <div id="txList"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbx4kBUmk0MkbPq1C_4Vi1I6BSmVLLAD3IenNBNmRfGMs5Ae3l4QerEZypRnXwuJEnNolQ/exec';
        let state = {
            user: JSON.parse(localStorage.getItem('user')) || null,
            transactions: [],
            currentType: 'income',
            profile: JSON.parse(localStorage.getItem('profile')) || { salary: 0, target: 0 }
        };

        // --- Core Functions ---
        function formatInput(el) {
            let val = el.value.replace(/\D/g, '');
            if(val) el.value = parseInt(val).toLocaleString('id-ID');
        }

        function formatRp(num) { return 'Rp ' + parseInt(num).toLocaleString('id-ID'); }

        function saveProfile() {
            const salary = parseInt(document.getElementById('profSalary').value.replace(/\D/g,'')) || 0;
            const target = parseInt(document.getElementById('profTarget').value.replace(/\D/g,'')) || 0;
            state.profile = { salary, target };
            localStorage.setItem('profile', JSON.stringify(state.profile));
            updateAdvice();
        }

        function updateAdvice() {
            const daily = Math.floor(Math.max(0, state.profile.salary - state.profile.target) / 30);
            document.getElementById('dailyLimit').textContent = formatRp(daily);
        }

        // --- Page Logic ---
        function switchPage(page, btn) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + 'Page').classList.remove('hidden');
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                btn.classList.add('active');
            }
            closeSidebar();
        }

        function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('active'); }
        function toggleTheme() {
            const dark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', dark ? 'light' : 'dark');
        }

        // --- Data Logic ---
        async function loadTransactions() {
            try {
                const res = await fetch(`${API_URL}?action=getTransactions&email=${state.user.email}`);
                const data = await res.json();
                if(data.status === 'success') {
                    state.transactions = data.data;
                    updateDashboard();
                    renderList(state.transactions);
                }
            } catch(e) { console.error("Koneksi gagal"); }
        }

        function updateDashboard() {
            const inc = state.transactions.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
            const exp = state.transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            document.getElementById('dashInc').textContent = formatRp(inc);
            document.getElementById('dashExp').textContent = formatRp(exp);
            document.getElementById('dashBal').textContent = formatRp(inc - exp);
            renderChart();
        }

        function setType(type) {
            state.currentType = type;
            document.getElementById('typeInc').style.background = type==='income' ? 'rgba(16,185,129,0.1)' : 'none';
            document.getElementById('typeExp').style.background = type==='expense' ? 'rgba(239,68,68,0.1)' : 'none';
            const cats = type==='income' ? ['Gaji', 'Bonus', 'Investasi'] : ['Makan', 'Transport', 'Belanja', 'Tagihan', 'Hiburan'];
            document.getElementById('category').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        document.getElementById('txForm').addEventListener('submit', async e => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const payload = {
                action: editId ? 'addTransaction' : 'addTransaction', // Re-add in GAS
                email: state.user.email,
                id: editId ? parseInt(editId) : Date.now(),
                type: state.currentType,
                amount: parseInt(document.getElementById('amount').value.replace(/\D/g,'')),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                description: document.getElementById('notes').value || 'Tanpa Catatan'
            };

            if(editId) { // Simulasikan edit dengan hapus lalu tambah (standar Apps Script)
                await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'deleteTransaction', id:parseInt(editId), email:state.user.email}) });
            }

            await fetch(API_URL, { method:'POST', body: JSON.stringify(payload) });
            loadTransactions();
            resetForm();
            switchPage('dashboard');
        });

        function editTx(id) {
            const tx = state.transactions.find(t => t.id === id);
            document.getElementById('editId').value = tx.id;
            document.getElementById('amount').value = parseInt(tx.amount).toLocaleString('id-ID');
            document.getElementById('date').value = tx.date;
            document.getElementById('notes').value = tx.description;
            setType(tx.type);
            document.getElementById('formTitle').textContent = "Edit Data";
            document.getElementById('btnCancel').classList.remove('hidden');
            switchPage('input');
        }

        async function deleteTx(id) {
            if(!confirm("Hapus data?")) return;
            await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'deleteTransaction', id, email:state.user.email}) });
            loadTransactions();
        }

        function resetForm() {
            document.getElementById('txForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = "Tambah Transaksi";
            document.getElementById('btnCancel').classList.add('hidden');
        }

        function renderList(data) {
            document.getElementById('txList').innerHTML = data.map(t => `
                <div class="transaction-item">
                    <div>
                        <p style="font-weight:600;">${t.description}</p>
                        <p style="font-size:0.7rem; color:var(--text-sub);">${t.category} • ${t.date}</p>
                    </div>
                    <div style="text-align:right;">
                        <p style="font-weight:700; color:${t.type==='income'?'var(--success)':'var(--danger)'}">${formatRp(t.amount)}</p>
                        <span onclick="editTx(${t.id})" style="color:var(--primary); cursor:pointer; font-size:0.8rem;">Edit</span> • 
                        <span onclick="deleteTx(${t.id})" style="color:var(--danger); cursor:pointer; font-size:0.8rem;">Hapus</span>
                    </div>
                </div>
            `).join('');
        }

        function filterList(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderList(type === 'all' ? state.transactions : state.transactions.filter(t => t.type === type));
        }

        // --- Auth ---
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            const res = await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'login', email, password:pass}) });
            const data = await res.json();
            if(data.status==='success') {
                state.user = data.data;
                localStorage.setItem('user', JSON.stringify(state.user));
                initApp();
            } else alert(data.message);
        });

        function logout() { localStorage.removeItem('user'); location.reload(); }

        // --- Chart ---
        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const data = state.transactions.slice(0, 7).reverse();
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(t => t.date.split('-')[2]),
                    datasets: [{ label: 'Arus Kas', data: data.map(t => t.type==='income'?t.amount:-t.amount), backgroundColor: data.map(t => t.type==='income'?'#10b981':'#ef4444') }]
                }
            });
        }

        function initApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('profSalary').value = parseInt(state.profile.salary).toLocaleString('id-ID');
            document.getElementById('profTarget').value = parseInt(state.profile.target).toLocaleString('id-ID');
            document.getElementById('userInfoDisplay').textContent = state.user.name;
            loadTransactions(); updateAdvice(); setType('income');
            document.getElementById('date').valueAsDate = new Date();
        }

        window.addEventListener('offline', () => document.getElementById('networkStatus').classList.add('offline'));
        window.addEventListener('online', () => document.getElementById('networkStatus').classList.remove('offline'));
    </script>
</body>
</html>
